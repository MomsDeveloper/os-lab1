# Лабораторная работа №1

Вариант: 

* ForkKind: `vfork`
* Bench 1: `(ema-sort-int)` - Сортировка массива чисел во внешней памяти
* Bench 2: `(dedup)` - Дедупликация элементов в массиве

## Задание Часть 1. Запуск программ

Необходимо реализовать собственную оболочку командной строки - shell. Выбор ОС для реализации производится на усмотрение студента. Shell должен предоставлять пользователю возможность запускать программы на компьютере с переданными аргументами командной строки и после завершения программы показывать реальное время ее работы (подсчитать самостоятельно как «время завершения» – «время запуска»).

## Задание Часть 2. Мониторинг и профилирование

Разработать комплекс программ-нагрузчиков по варианту, заданному преподавателем. Каждый нагрузчик должен, как минимум, принимать параметр, который определяет количество повторений для алгоритма, указанного в задании. Программы должны нагружать вычислительную систему, дисковую подсистему или обе подсистемы сразу. Необходимо скомпилировать их без опций оптимизации компилятора.

Перед запуском нагрузчика, попробуйте оценить время работы вашей программы или ее результаты (если по варианту вам досталось измерение чего-либо). Постарайтесь обосновать свои предположения. Предположение можно сделать, основываясь на своем опыте, знаниях ОС и характеристиках используемого аппаратного обеспечения.

1. Запустите программу-нагрузчик и зафиксируйте метрики ее работы с помощью инструментов для профилирования. Сравните полученные результаты с ожидаемыми. Постарайтесь найти объяснение наблюдаемому.

2. Определите количество нагрузчиков, которое эффективно нагружает все ядра процессора на вашей системе. Как распределяются времена `USER%`, `SYS%`, `WAIT%`, а также реальное время выполнения нагрузчика? Какое количество переключений контекста (вынужденных и невынужденных) происходит при этом?

3. Увеличьте количество нагрузчиков вдвое, втрое, вчетверо. Как изменились времена, указанные на предыдущем шаге? Как ведет себя ваша система?

4. Объедините программы-нагрузчики в одну, реализованную при помощи потоков выполнения, чтобы один нагрузчик эффективно нагружал все ядра вашей системы. Как изменились времена для того же объема вычислений? Запустите одну, две, три таких программы.

5. Добавьте опции агрессивной оптимизации для компилятора. Как изменились времена? На сколько сократилось реальное время исполнения программы нагрузчика?

## Ограничения

Программа (комплекс программ) должна быть реализована на языке C, C++. Дочерние процессы должны быть созданы через заданные системные вызовы выбранной операционной системы, с обеспечением корректного запуска и завершения процессов. Запрещено использовать высокоуровневые абстракции над системными вызовами. Необходимо использовать, в случае Unix, процедуры `libc`.


## Выполнение

Часть 1. Запуск программ

<!-- 1. Реализована оболочка командной строки - add link to main file -->
1. Реализована оболочка командной строки - [shell.c](./src/shell.c). Программа запускает программы с переданными аргументами и показывает время работы программы.

Часть 2. Мониторинг и профилирование

1. Разработаны программы-нагрузчики:
    * [ema-sort-int.c](./src/ema-sort-int.c) - Сортировка массива чисел во внешней памяти
    * [dedup.c](./src/dedup.c) - Дедупликация элементов в массиве
    * [complex.c](./src/complex.c) - Комплексная программа-нагрузчик, объединяющая две предыдущие программы в одну, реализованную при помощи потоков выполнения

2. Профилирование программы `ema-sort-int`:
    2.1  1 итерация исполнения, 1 MB данных:
    * perf
    ```
               238.32 msec task-clock                       #    0.092 CPUs utilized             
                18688      context-switches                 #   78.416 K/sec                     
                   11      cpu-migrations                   #   46.157 /sec                      
                  163      page-faults                      #  683.962 /sec                      
      <not supported>      cycles                                                                
      <not supported>      instructions                                                          
      <not supported>      branches                                                              
      <not supported>      branch-misses                                                         
      <not supported>      L1-dcache-loads                                                       
      <not supported>      L1-dcache-load-misses                                                 
      <not supported>      LLC-loads                                                             
      <not supported>      LLC-load-misses                                                       

        2.579066293 seconds time elapsed

        0.092570000 seconds user
        0.212521000 seconds sys

    ```

    * top
    ```
    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  43861 ubuntu    20   0   12188   5248   3200 S   9.1   0.3   0:34.26 top
 332076 ubuntu    20   0    2260   1152   1024 R   9.1   0.1   0:00.02 ema-sor+
      1 root      20   0   21932  12388   8676 S   0.0   0.6   0:02.01 systemd
    ```

    * mpstat
    ```
    Average:     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    Average:     all    0.33    0.00    0.98    0.00    0.00    0.00    0.00    0.00    0.00   98.70
    Average:       0    0.33    0.00    0.98    0.00    0.00    0.00    0.00    0.00    0.00   98.69
    Average:       1    0.33    0.00    0.98    0.00    0.00    0.00    0.00    0.00    0.00   98.70
    Average:       2    0.00    0.00    0.98    0.00    0.00    0.00    0.00    0.00    0.00   99.02
    Average:       3    0.65    0.00    0.97    0.00    0.00    0.00    0.00    0.00    0.00   98.38
    ```

3. Профилирование программы `dedup`:
    3.1 1 итерация исполнения, 102400 элементов:
    * perf
    ```
           6159.90 msec task-clock                       #    0.999 CPUs utilized             
                20      context-switches                 #    3.247 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
               145      page-faults                      #   23.539 /sec                      
   <not supported>      cycles                                                                
   <not supported>      instructions                                                          
   <not supported>      branches                                                              
   <not supported>      branch-misses                                                         
   <not supported>      L1-dcache-loads                                                       
   <not supported>      L1-dcache-load-misses                                                 
   <not supported>      LLC-loads                                                             
   <not supported>      LLC-load-misses                                                       

       6.163559211 seconds time elapsed

       6.160164000 seconds user
       0.000000000 seconds sys
    ```
    * top
    ```
    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 332397 ubuntu    20   0    2656   1152    768 R 100.0   0.1   0:03.25 dedup
    966 ubuntu    20   0   16428   6420   4736 S   0.3   0.3   0:27.19 sshd
  38533 ubuntu    20   0   12188   5248   3200 S   0.3   0.3   0:33.79 top
  86023 ubuntu    20   0   12184   5248   3200 S   0.3   0.3   0:31.49 top
    ```
    * mpstat
    ```
    02:24:11     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    02:24:12     all    0.76    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   98.23
    02:24:12       0    1.01    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   97.98
    02:24:12       1    1.01    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   97.98
    02:24:12       2    1.01    0.00    1.01    0.00    0.00    0.00    0.00    0.00    0.00   97.98
    02:24:12       3    0.00    0.00    1.02    0.00    0.00    0.00    0.00    0.00    0.00   98.98
    ```
4. Профилирование программы `complex`:

    